import matplotlib.pyplot as plt
import numpy as np

S = """
2025-11-27 13:27:40
data: 26,3,24,1,24,1,50,1,48,1,94,2,26,3,51,1,25,2,92,1,48,2,71,1,95,1,71,0,92,3,51,0,68,2,51,0,24,0,
1713 1bb64
2025-11-27 13:28:0
data: 48,2,26,2,27,2,53,1,49,1,98,2,27,3,48,0,26,2,70,0,57,0,69,0,94,0,69,2,96,2,49,0,70,4,50,0,25,0,
41712 1bb64
2025-11-27 13:28:20
data: 78,1,31,0,24,0,50,0,48,1,96,1,27,0,50,0,25,2,71,1,49,0,69,0,96,0,73,0,96,1,46,0,73,3,49,0,29,0,
81712 1bb64
2025-11-27 13:28:40
data: 27,0,26,0,28,0,48,1,50,0,94,0,46,0,47,0,26,1,73,0,48,1,73,1,95,0,75,0,92,0,49,0,74,0,47,0,24,0,
1752 1bb64
2025-11-27 13:29:0
data: 47,3,30,0,28,0,49,1,46,2,94,2,50,0,49,0,29,0,96,2,48,2,69,1,95,0,72,0,97,2,48,1,68,3,47,0,26,0,
41753 1bb64
2025-11-27 13:29:20
data: 77,0,23,3,30,1,52,2,48,1,94,2,50,0,49,2,30,0,99,0,46,1,71,1,95,0,73,0,92,0,47,0,75,2,48,2,24,0,
81753 1bb64
2025-11-27 13:29:40
data: 29,0,27,0,20,0,50,0,50,0,94,0,74,0,49,0,27,0,74,0,51,0,71,0,94,0,70,0,95,0,52,0,74,0,48,0,26,0,
1792 1bb64
2025-11-27 13:30:0
data: 49,0,29,0,27,0,49,0,47,0,96,0,71,0,48,0,26,0,96,0,47,0,72,0,95,0,72,0,96,0,45,0,75,0,49,1,33,0,
41793 1bb64
2025-11-27 13:30:20
data: 73,1,24,0,27,0,48,1,48,0,97,0,70,1,50,0,28,1,95,0,47,0,71,0,94,2,71,0,97,2,50,0,70,0,46,0,27,0,
81793 1bb64
2025-11-27 13:30:40
data: 29,1,30,0,28,1,48,0,48,2,94,0,100,1,49,0,27,1,94,0,49,0,75,0,97,1,74,0,95,0,48,0,73,0,49,0,28,0,
17d3 1bb64
2025-11-27 13:31:0
data: 54,0,25,0,29,0,51,0,52,0,96,0,96,0,49,0,27,0,73,0,48,0,75,0,94,0,72,0,93,0,52,0,73,0,49,0,25,0,
417d2 1bb64
2025-11-27 13:31:20
"""

S = """
data: 70,0,34,4,96,0,79,0,103,0,68,6,107,6,71,7,48,19,131,0,77,5,99,0,142,0,110,4,141,5,70,3,96,0,80,0,55,0,
low signal failed
data: 53,3,47,5,104,1,67,10,102,4,69,0,101,25,70,11,29,0,100,38,67,1,94,0,98,29,95,0,97,35,62,13,105,0,62,2,45,7,
low signal failed
data: 37,0,37,0,99,2,81,0,106,0,95,9,34,0,62,0,28,0,141,0,73,0,100,0,135,0,97,0,121,0,61,4,100,0,66,0,36,0,
high signal failed
data: 106,3,45,0,97,2,67,2,99,2,97,2,41,0,64,0,35,0,99,3,69,0,97,0,126,3,100,2,134,1,75,0,100,1,67,0,40,0,
high signal failed
data: 34,0,36,0,105,0,71,0,98,0,100,0,106,1,69,0,37,0,98,0,66,0,99,0,132,0,98,0,129,0,70,0,105,0,68,0,34,0,
high signal failed
data: 98,2,39,12,109,4,85,9,107,12,102,4,111,1,71,1,49,5,134,0,64,2,107,14,132,0,100,1,143,0,77,0,101,0,60,8,44,0,
low signal failed
data: 72,1,46,2,102,2,68,0,96,1,138,2,32,0,65,0,30,2,132,0,76,0,97,2,141,2,100,3,131,3,66,2,105,0,70,4,44,0,
high signal failed
data: 32,7,34,4,93,6,62,4,95,5,125,8,60,8,66,3,37,4,124,8,62,5,96,2,137,5,95,2,128,4,68,8,92,0,62,1,33,0,
high signal failed
data: 99,8,33,0,98,6,62,5,96,2,134,4,63,3,65,5,35,1,99,5,66,6,109,4,131,6,100,2,124,10,77,11,102,3,75,1,34,8,
high signal failed
data: 98,0,41,2,96,0,62,3,111,1,126,0,99,0,69,1,33,0,102,6,61,0,94,0,130,0,98,3,137,0,65,0,98,3,70,4,35,0,
high signal failed
data: 75,0,46,12,98,0,73,0,97,0,134,0,127,0,72,0,41,0,139,4,65,0,96,2,130,0,102,1,137,1,70,0,96,0,68,5,33,14,
low signal failed
data: 48,0,73,10,96,5,75,0,122,6,39,1,51,2,76,4,56,0,126,3,68,2,110,4,131,1,92,3,126,0,63,0,99,1,74,2,36,0,
high signal failed
data: 104,7,35,0,94,4,75,0,99,31,39,0,41,0,64,0,54,0,101,21,71,0,97,4,95,33,95,2,96,38,81,0,99,14,68,0,39,0,
low signal failed
data: 62,0,34,3,92,5,93,0,141,4,40,2,63,0,81,0,28,0,136,2,71,6,111,7,125,2,99,9,135,2,65,2,92,0,65,1,36,0,
high signal failed
data: 41,0,38,0,101,0,67,0,133,0,39,0,103,0,66,0,34,0,99,0,62,0,100,0,128,0,98,0,128,0,74,0,99,0,70,0,35,0,
high signal failed

"""


def get_data_blocks(s):
    blocks = []
    lines = s.strip().splitlines()
    for line in lines:
        if line.startswith("data: "):
            parts = line[6:].split(",")
            numbers = [int(part) for part in parts if part.strip().isdigit()]
            blocks.append(numbers)
    return blocks


delim = [0.10, 0.14, 0.32, 0.34, 0.52, 0.54, 0.72, 0.74, 0.92]
delim2 = [round(d * 160) for d in delim]
print("Delimiters:", delim2)


def pulse_to_bits(count):
    if count <= delim2[0]:
        return None
    if delim2[1] <= count <= delim2[2]:
        return "00"
    if delim2[3] <= count <= delim2[4]:
        return "01"
    if delim2[5] <= count <= delim2[6]:
        return "10"
    if delim2[7] <= count <= delim2[8]:
        return "11"
    return None


def block_to_bits(block):
    bits = ""
    for i in range(19):
        b = pulse_to_bits(block[i * 2])
        if b is None:
            return None
        bits += b
    return bits


def get_time(bits):
    P1 = bits[19]
    P2 = bits[37]

    if parity(bits[0:18]) != int(P1):
        return "Parity Error P1"
    if parity(bits[20:36]) != int(P2):
        return "Parity Error P2"

    s = int(bits[0:2], 2) * 20
    h = int(bits[4:8], 2)
    m = int(bits[8:14], 2)

    weekday = int(bits[15:18], 2)
    if bits[18] == "1":
        if h != 12:
            h += 12
    else:
        if h == 12:
            h = 0

    day = int(bits[21:26], 2)
    month = int(bits[26:30], 2)
    year = int(bits[30:36], 2) + int(bits[36]) * 64 + 2000
    return f"{year}-{month:02}-{day:02} {h:02}:{m:02}:{s:02}"


def parity(bits):
    return bits.count("1") % 2


data_blocks = get_data_blocks(S)
hist = [0] * 160
for i, block in enumerate(data_blocks):
    print(f"Data Block {i+1}: {block}")
    for j in block[2:]:
        if j < 3:
            continue
        hist[j] += 1
    bits = block_to_bits(block)
    if bits is not None:
        print(f"Bits: {bits}")
        time_str = get_time(bits)
        print(f"Time: {time_str}")

plt.bar(range(len(hist)), hist)
plt.vlines(delim2, 0, max(hist), colors="r", linestyles="dashed")
plt.xlabel("Value")
plt.ylabel("Frequency")
plt.title("Histogram of Values from Data Blocks")
plt.show()
